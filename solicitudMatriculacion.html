<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Matriculación</title>
    <link rel="stylesheet" href="css.css">
</head>
<body>
    <div class="top-info-bar">
        <p> Av. El Retorno 5-130 y Av. Ricardo Sánchez, Ibarra, Ecuador | uevmg@gmail.com</p>
    </div>
    <header>
        <div class="header-top">
            <img src="unidad-educativa-logo.png" alt="Logo de la Institución" class="logo">
            <div class="header-text">
                <h1>Unidad Educativa "Victor Manuel Guzman"</h1>
                <p>50 años de Educación Estudiantil</p>
            </div>
            <div class="auth-links">
                <a href="registro.html">Registrarse</a>
                <a href="#" id="logout">Cerrar Sesión</a>
            </div>
        </div>
        <nav>
            <ul class="menu">
                <li><a href="index.html">Inicio</a></li>
                <li class="dropdown">
                    <a href="#">Institución</a>
                    <ul class="submenu">
                        <li><a href="autoridades.html">Autoridades</a></li>
                        <li><a href="index.html#consejo">Consejo Ejecutivo</a></li>
                        <li><a href="index.html#historia">Historia</a></li>
                        <li><a href="index.html#patrono">Patrono</a></li>
                        <li><a href="index.html#uniforme">Uniforme</a></li>
                        <li><a href="index.html#himno">Himno</a></li>
                        <li><a href="index.html#datos">Datos Informativos</a></li>
                    </ul>
                </li>
                <li><a href="index.html#docentes">Docentes</a></li>
                <li><a href="index.html#dece">DECE</a></li>
                <li><a href="index.html#recursos">Recursos Didácticos</a></li>
                <li><a href="index.html#fotos">Fotos</a></li>
                <li><a href="ubicacion.html">Ubicación</a></li>
                <li class="dropdown">
                    <a href="#">Registro</a>
                    <ul class="submenu">
                        <li><a href="matriculacion.html" target="_blank">Matriculación</a></li>
                        <li><a href="requisitos.html" target="_blank">Requisitos</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="centered-section">
            <h2>Solicitudes de Matriculación</h2>
            <div class="category">
                <div class="category-header">
                    <h3>Solicitudes Entrantes</h3>
                    <button class="toggle-category" data-category="entrantes">▼</button>
                </div>
                <div id="solicitudes-entrantes" class="category-content">
                    <!-- Las solicitudes entrantes se cargarán aquí dinámicamente -->
                </div>
            </div>
            <div class="category">
                <div class="category-header">
                    <h3>Solicitudes Verificadas</h3>
                    <button class="toggle-category" data-category="verificadas">▼</button>
                </div>
                <div id="solicitudes-verificadas" class="category-content"> 
                    <!-- Las solicitudes verificadas se cargarán aquí dinámicamente -->
                </div>
            </div>
            
        </section>
    </main>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // Configuración de Supabase
        const supabaseUrl = "https://zeijayrxciyzymysbyvp.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplaWpheXJ4Y2l5enlteXNieXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNjYyMjMsImV4cCI6MjA1OTc0MjIyM30.DxT8_5acA88JxhVV7n2UqmrZ_9d0DPABi6eKSO8cpDE"; // Reemplaza con la nueva clave válida
        const supabase = createClient(supabaseUrl, supabaseKey);

        document.addEventListener("DOMContentLoaded", async () => {
            const usuarioActivo = localStorage.getItem('usuarioActivo');

            if (!usuarioActivo) {
                alert('No tienes permisos para acceder a esta página.');
                window.location.href = 'index.html';
                return;
            }

            try {
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('rol')
                    .eq('email', usuarioActivo);

                if (error || !usuarios || usuarios.length === 0 || (usuarios[0].rol !== 'administrador' && usuarios[0].rol !== 'admin')) {
                    alert('No tienes permisos para acceder a esta página.');
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error('Error al verificar permisos:', err);
                alert('Ocurrió un error inesperado. Serás redirigido al inicio.');
                window.location.href = 'index.html';
            }

            const solicitudesEntrantesContainer = document.getElementById("solicitudes-entrantes");
            const solicitudesVerificadasContainer = document.getElementById("solicitudes-verificadas");
            const menu = document.querySelector('.menu');
            const adminEmail = localStorage.getItem('adminEmail') || 'admin@ejemplo.com';
            const authLinks = document.querySelector('.auth-links');

            // Función para cargar solicitudes
            async function cargarSolicitudes() {
                try {
                    const { data: solicitudes, error } = await supabase
                        .from('solicitudesMatriculacion')
                        .select('*');

                    if (error) {
                        console.error('Error al cargar solicitudes:', error.message);
                        return;
                    }

                    solicitudesEntrantesContainer.innerHTML = '';
                    solicitudesVerificadasContainer.innerHTML = '';

                    solicitudes.forEach((solicitud, index) => {
                        const solicitudDiv = document.createElement("div");
                        solicitudDiv.classList.add("solicitud");

                        solicitudDiv.innerHTML = `
                            <div class="solicitud-header">
                                <h3>Solicitud #${index + 1}</h3>
                                <button class="toggle-btn" data-index="${index}">▼</button>
                            </div>
                            <div class="solicitud-content" id="solicitud-content-${index}" style="display: none;">
                                <h4 class="section-header">Datos del Estudiante</h4>
                                <p><strong>Código:</strong> ${solicitud.codigo}</p>
                                <p><strong>Apellidos:</strong> ${solicitud.apellidos}</p>
                                <p><strong>Nombres:</strong> ${solicitud.nombres}</p>
                                <p><strong>Cédula:</strong> ${solicitud.cedula_estudiante}</p>
                                <p><strong>Provincia de Nacimiento:</strong> ${solicitud.provincia_nacimiento}</p>
                                <p><strong>Cantón:</strong> ${solicitud.canton}</p>
                                <p><strong>Género:</strong> ${solicitud.genero}</p>
                                <p><strong>Fecha de Nacimiento:</strong> ${solicitud.fecha_nacimiento}</p>
                                <p><strong>Nacionalidad:</strong> ${solicitud.nacionalidad}</p>
                                <p><strong>Institución de Procedencia:</strong> ${solicitud.institucion_procede}</p>
                                <h4 class="section-header">Datos del Representante</h4>
                                <p><strong>Apellidos y Nombres:</strong> ${solicitud.representante_nombres}</p>
                                <p><strong>Cédula:</strong> ${solicitud.representante_cedula}</p>
                                <p><strong>Teléfono Convencional:</strong> ${solicitud.representante_telefono}</p>
                                <p><strong>Número Celular:</strong> ${solicitud.representante_celular}</p>
                                <p><strong>Profesión:</strong> ${solicitud.representante_profesion}</p>
                                <p><strong>Email:</strong> ${solicitud.representante_email}</p>
                                <p><strong>Dirección del Trabajo:</strong> ${solicitud.direccion_trabajo_representante}</p>
                                <p><strong>Vive con el Estudiante:</strong> ${solicitud.vive_con_estudiante_representante ? 'Sí' : 'No'}</p>
                                <p><strong>Es Representante del Estudiante:</strong> ${solicitud.es_representante_representante ? 'Sí' : 'No'}</p>
                                <p><strong>Nacionalidad:</strong> ${solicitud.nacionalidad_representante}</p>
                                <h4 class="section-header">Datos de la Madre</h4>
                                <p><strong>Apellidos y Nombres:</strong> ${solicitud.madre_nombres}</p>
                                <p><strong>Cédula:</strong> ${solicitud.madre_cedula}</p>
                                <p><strong>Teléfono Convencional:</strong> ${solicitud.madre_telefono}</p>
                                <p><strong>Número Celular:</strong> ${solicitud.madre_celular}</p>
                                <p><strong>Profesión:</strong> ${solicitud.madre_profesion}</p>
                                <p><strong>Email:</strong> ${solicitud.madre_email}</p>
                                <p><strong>Dirección del Trabajo:</strong> ${solicitud.direccion_trabajo_madre}</p>
                                <p><strong>Vive con el Estudiante:</strong> ${solicitud.vive_con_estudiante_madre ? 'Sí' : 'No'}</p>
                                <p><strong>Es Representante del Estudiante:</strong> ${solicitud.es_representante_madre ? 'Sí' : 'No'}</p>
                                <p><strong>Nacionalidad:</strong> ${solicitud.nacionalidad_madre}</p>
                                <h4 class="section-header">Datos del Padre</h4>
                                <p><strong>Apellidos y Nombres:</strong> ${solicitud.padre_nombres}</p>
                                <p><strong>Cédula:</strong> ${solicitud.padre_cedula}</p>
                                <p><strong>Teléfono Convencional:</strong> ${solicitud.padre_telefono}</p>
                                <p><strong>Número Celular:</strong> ${solicitud.padre_celular}</p>
                                <p><strong>Profesión:</strong> ${solicitud.padre_profesion}</p>
                                <p><strong>Email:</strong> ${solicitud.padre_email}</p>
                                <p><strong>Dirección del Trabajo:</strong> ${solicitud.direccion_trabajo_padre}</p>
                                <p><strong>Vive con el Estudiante:</strong> ${solicitud.vive_con_estudiante_padre ? 'Sí' : 'No'}</p>
                                <p><strong>Es Representante del Estudiante:</strong> ${solicitud.es_representante_padre ? 'Sí' : 'No'}</p>
                                <p><strong>Nacionalidad:</strong> ${solicitud.nacionalidad_padre}</p>
                                <h4 class="section-header">Ubicación de la Vivienda</h4>
                                <p><strong>Provincia:</strong> ${solicitud.provincia_vivienda}</p>
                                <p><strong>Ciudad:</strong> ${solicitud.ciudad}</p>
                                <p><strong>Parroquia:</strong> ${solicitud.parroquia}</p>
                                <p><strong>Sector:</strong> ${solicitud.sector}</p>
                                <p><strong>Dirección:</strong> ${solicitud.direccion}</p>
                                <p><strong>Teléfono Convencional:</strong> ${solicitud.telefono_convencional}</p>
                                <h4 class="section-header">Contacto de Emergencia</h4>
                                <p><strong>Nombres y Apellidos:</strong> ${solicitud.emergencia_nombres}</p>
                                <p><strong>Parentesco:</strong> ${solicitud.emergencia_parentesco}</p>
                                <p><strong>Teléfono:</strong> ${solicitud.telefono_emergencia}</p>
                                <h4 class="section-header">Ubicación</h4>
                                <p><strong>Latitud:</strong> ${solicitud.latitud}</p>
                                <p><strong>Longitud:</strong> ${solicitud.longitud}</p>
                                <div id="map-${index}" style="width: 100%; height: 300px; border: 1px solid #ccc; margin-top: 1rem;"></div>
                                <button class="verificar-btn" data-id="${solicitud.id}" data-verificado="${solicitud.verificado}">
                                    ${solicitud.verificado ? 'Mover a Entrantes' : 'Verificar Solicitud'}
                                </button>
                            </div>
                        `;

                        const container = solicitud.verificado ? solicitudesVerificadasContainer : solicitudesEntrantesContainer;
                        container.appendChild(solicitudDiv);

                        // Mostrar el mapa
                        const map = new google.maps.Map(document.getElementById(`map-${index}`), {
                            center: { lat: parseFloat(solicitud.latitud), lng: parseFloat(solicitud.longitud) },
                            zoom: 15,
                        });

                        new google.maps.Marker({
                            position: { lat: parseFloat(solicitud.latitud), lng: parseFloat(solicitud.longitud) },
                            map: map,
                        });
                    });
                } catch (err) {
                    console.error('Error inesperado al cargar solicitudes:', err);
                }
            }

            // Función para cambiar el estado de verificación de una solicitud
            async function cambiarEstadoSolicitud(id, verificado) {
                try {
                    const { error } = await supabase
                        .from('solicitudesMatriculacion')
                        .update({ verificado })
                        .eq('id', id);

                    if (error) {
                        console.error('Error al cambiar el estado de la solicitud:', error.message);
                        alert('Error al cambiar el estado de la solicitud.');
                    } else {
                        cargarSolicitudes();
                    }
                } catch (err) {
                    console.error('Error inesperado al cambiar el estado de la solicitud:', err);
                }
            }

            // Delegación de eventos para manejar clics en los botones de verificar
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('verificar-btn')) {
                    const id = e.target.dataset.id;
                    const verificado = e.target.dataset.verificado === 'true' ? false : true;
                    cambiarEstadoSolicitud(id, verificado);
                }
            });

            // Delegación de eventos para minimizar/maximizar solicitudes
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-btn')) {
                    const index = e.target.dataset.index;
                    const content = document.getElementById(`solicitud-content-${index}`);
                    const isVisible = content.style.display !== 'none';
                    content.style.display = isVisible ? 'none' : 'block';
                    e.target.textContent = isVisible ? '▼' : '▲';
                }
            });

            // Delegación de eventos para minimizar/maximizar categorías
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-category')) {
                    const category = e.target.dataset.category;
                    const content = document.getElementById(`solicitudes-${category}`);
                    const isVisible = content.style.display !== 'none';
                    content.style.display = isVisible ? 'none' : 'block';
                    e.target.textContent = isVisible ? '▼' : '▲';
                }
            });

            cargarSolicitudes();

            // Cargar el script de Google Maps
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyASXHq4iXJSrxjYPatO4smsajz0BlH37JE`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            if (usuarioActivo) {
                // Mostrar "Matricularse" y "Cerrar Sesión"
                authLinks.innerHTML = `
                    <a href="matricularse.html">Matricularse</a>
                    <a href="#" id="logout">Cerrar Sesión</a>
                `;
                document.getElementById('logout').addEventListener('click', () => {
                    localStorage.removeItem('usuarioActivo');
                    alert('Sesión cerrada exitosamente.');
                    window.location.href = 'index.html';
                });

                // Verificar si el usuario tiene rol de administrador o admin
                try {
                    const { data: usuarios, error } = await supabase
                        .from('usuarios')
                        .select('rol')
                        .eq('email', usuarioActivo);

                    if (error) {
                        console.error('Error al verificar el rol del usuario:', error.message);
                    } else if (usuarios && usuarios.length > 0 && (usuarios[0].rol === 'administrador' || usuarios[0].rol === 'admin')) {
                        // Agregar opción de "Administración" al menú
                        if (!menu.querySelector('a[href="verUsuarios.html"]')) {
                            const adminMenuItem = document.createElement('li');
                            adminMenuItem.classList.add('dropdown');
                            adminMenuItem.innerHTML = `
                                <a href="#">Administración</a>
                                <ul class="submenu">
                                    <li><a href="verUsuarios.html">Ver Usuarios</a></li>
                                    <li><a href="solicitudMatriculacion.html">Solicitudes de Matriculación</a></li>
                                </ul>
                            `;
                            menu.appendChild(adminMenuItem);
                        }
                    }
                } catch (err) {
                    console.error('Error inesperado al verificar el rol del usuario:', err);
                }
            }
        });
    </script>
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>UNIDAD EDUCATIVA "VICTOR MANUEL GUZMAN"</h3>
                <div class="footer-line"></div>
                <p>Todos los contenidos digitales del portal web, se prohíbe su reproducción total, parcial y traducción a cualquier idioma sin autorización escrita por su titular.</p>
            </div>
            <div class="footer-section">
                <h3>ACCESOS DIRECTOS</h3>
                <div class="footer-line"></div>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="registro.html">Registro</a></li>
                    <li><a href="autoridades.html">Autoridades</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>CONTACTOS</h3>
                <div class="footer-line"></div>
                <p>Av. El Retorno 5-130 y Av. Ricardo Sánchez, Ibarra, Ecuador</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Unidad Educativa Victor Manuel Guzmán © Copyrights 2025 Diseñado por área de Informática</p>
        </div>
    </footer>
</body>
</html>
